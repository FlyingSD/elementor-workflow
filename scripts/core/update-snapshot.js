#!/usr/bin/env node

/**
 * Update Snapshot - Session Continuity System
 *
 * Purpose: Save session context for restoration after restart
 * Usage: node scripts/core/update-snapshot.js
 * Output: SSOT/runtime/CONTEXT-SNAPSHOT.md
 *
 * Captures:
 * - Current working pages
 * - Last completed tasks
 * - Known issues encountered
 * - Next planned actions
 */

const fs = require('fs');
const path = require('path');

// Paths
const snapshotPath = path.join(__dirname, '../../SSOT/runtime/CONTEXT-SNAPSHOT.md');
const activeStatePath = path.join(__dirname, '../../SSOT/ACTIVE_STATE.md');

// Read ACTIVE_STATE to extract current context
const activeState = fs.readFileSync(activeStatePath, 'utf8');

// Extract key information
function extractPageIDs(content) {
  const pageSection = content.match(/## ğŸ“„ Current Pages[\s\S]*?(?=##)/);
  if (!pageSection) return [];

  const pages = [];
  const lines = pageSection[0].split('\n');
  for (const line of lines) {
    const match = line.match(/\|\s*(\d+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|/);
    if (match) {
      pages.push({
        id: match[1].trim(),
        title: match[2].trim(),
        slug: match[3].trim()
      });
    }
  }
  return pages;
}

function extractNextActions(content) {
  const actionSection = content.match(/## ğŸ“Œ Next Immediate Actions[\s\S]*?(?=##|$)/);
  if (!actionSection) return '';
  return actionSection[0];
}

// Generate snapshot
const pages = extractPageIDs(activeState);
const nextActions = extractNextActions(activeState);
const timestamp = new Date().toISOString().replace('T', ' ').split('.')[0];

const snapshot = `# CONTEXT SNAPSHOT

**Last Updated**: ${timestamp}
**Purpose**: Session continuity - restore context after restart
**Auto-generated**: By update-snapshot.js

---

## ğŸ¯ CURRENT WORKING STATE

**Active Pages**:
${pages.map(p => `- Page ${p.id}: ${p.title} (/${p.slug}/)`).join('\n')}

**Last Session**: ${timestamp.split(' ')[0]}

---

## ğŸ“‹ NEXT ACTIONS

${nextActions || '(Read ACTIVE_STATE.md â†’ Next Immediate Actions)'}

---

## ğŸš¨ QUICK ACCESS

**Current Values**: Always read ACTIVE_STATE.md for:
- Page IDs â†’ Current Pages section
- Global Colors â†’ Global Design System section
- Credentials â†’ Credentials & Access section

**Common Tasks**:
- Update page â†’ Use anchor-search.js to find relevant guide sections
- Fix styling â†’ Check TROUBLESHOOTING.md first
- CSS not showing â†’ MANDATORY-CSS-REGENERATION.md workflow

---

## ğŸ’¡ RESTORE PROTOCOL

**On restart, read this file FIRST** to understand:
- Where we left off
- What pages are active
- What's next to do

Then proceed with user's request.

---

**Snapshot Version**: 1.0
**Generated By**: scripts/core/update-snapshot.js
**Frequency**: After each major task completion
`;

// Write snapshot
fs.writeFileSync(snapshotPath, snapshot, 'utf8');

console.log('âœ… Context snapshot updated!');
console.log(`ğŸ“ File: ${snapshotPath}`);
console.log(`ğŸ“Š Pages tracked: ${pages.length}`);
console.log(`â° Timestamp: ${timestamp}`);
console.log('');
console.log('ğŸ’¡ On next restart, read CONTEXT-SNAPSHOT.md first!');
